<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css"
          integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">
    <title>Log viewer</title>
</head>
<style>
    .content {
        padding: 1em
    }

    .table {
        display: block;
        max-height: 500px;
        overflow: scroll;
    }

    .pd-x-none {
        padding-left: 0;
        padding-right: 0
    }

    .page {
        width: 65px;
    }

    input, select {
        height: 32.5px !important;
    }

    .toolbar {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px
    }
</style>
<body>
<div class="content">
    <div class="content pd-x-none">
        <div class="pure-g">
            <div class="pure-u-1-2">
                <form class="pure-form toolbar" onsubmit="submitToolbar(event)">
                    <div>
                        <input type="text" name="type_filter" placeholder="Type filter" style="width: 100%"/>
                    </div>
                    <div>
                        <select name="sort_direction" style="width: 100%">
                            <option value="" selected>Ts sort</option>
                            <option value="asc">ASC</option>
                            <option value="desc">DESC</option>
                        </select>
                    </div>
                    <div>
                        <button class="pure-button pure-button-primary">Go</button>
                        <button class="pure-button pure-button-primary" onclick="window.location.href='/'"
                                type="button">Clear
                        </button>
                    </div>
                </form>
            </div>
            <div class="pure-u-1-2">
                <div style="text-align: right"><b id="rows_count">Rows: 0</b></div>
            </div>
        </div>
    </div>

    <table class="pure-table pure-table-striped table">
        <thead>
        <tr>
            <th>#</th>
            <th>Ts</th>
            <th>Type</th>
            <th>Message</th>
        </tr>
        </thead>
        <tbody class="tbody-test">
        {{ range .Logs }}
            <tr>
                <td>{{ .Id }}</td>
                <td>{{ .TsPretty }}</td>
                <td>{{ .Type }}</td>
                <td>{{ .Message }}</td>
            </tr>
        {{ end }}
        </tbody>
    </table>
    <div class="content pd-x-none" style="width:220px">
        <div class="pure-g">
            <div class="pure-u-1-3">
                <a class="pure-button" onclick="updatePage('{{.FromCursor}}', 'prev')">Prev</a>
            </div>
            <div class="pure-u-1-3">
                <form class="pure-form" action="/showPage" method="GET" onsubmit="submitPage(event)">
                    <input type="text" class="page" name="page" value="0" id="page"/>
                </form>
            </div>
            <div class="pure-u-1-3">
                <a class="pure-button" onclick="updatePage('{{.ToCursor}}', 'next')">Next</a>
            </div>
        </div>
    </div>
</div>
<script>
    const params = new URLSearchParams(window.location.search);

    function updatePage(cursor, action) {
        params.set("cursor", cursor);
        if (action === "prev") {
            params.set("sort_direction", "desc")
        }
        if (action === "next") {
            params.set("sort_direction", "asc")
        }
        if (!params.has("sort_field")) {
            params.set("sort_field", "id");
        }
        window.location.href = `/?${params.toString()}`;
    }

    function submitToolbar(e) {
        e.preventDefault();
        let f = new FormData(e.target);
        let keys = [];
        for (let [k,_] of params.entries()) {
            keys.push(k);
        }
        for (let k of keys) {
            params.delete(k);
        }
        for (let [k, v] of f.entries()) {
            v !== "" && params.set(k, v.toString());
            if (k === "sort_direction" && params.has("sort_direction")) {
                params.set("sort_field", "ts");
            }
        }
        window.location.href = `/?${params.toString()}`;
    }

    function submitPage(e) {
        e.preventDefault();
        const page = document.querySelector("input[name=page]").value;
        params.set("page", page);
        window.location.href = `/showPage?${params.toString()}`;
    }

    (async function () {
        const page = document.getElementById("page");
        page.value = "...loading";

        if (params.has('page')) {
            page.value = params.get('page');
            params.delete('page');
            return;
        }

        fetch("/pageNumber", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                'sort': {
                    'field': params.get('sort_field'),
                    'direction': params.get('sort_direction'),
                },
                'cursor': params.get('cursor'),
            })
        }).then(function (resp) {
            return resp.json();
        }).then(function (data) {
            page.value = data.page;
        }).catch(function (e) {
            throw e;
        });
    })();

    (async function () {
        const rows = document.getElementById("rows_count");
        rows.innerText = `Rows: ...loading`;

        fetch("/totalRows", {
            method: "GET",
            headers: {"Content-Type": "application/json"},
        }).then(function (resp) {
            return resp.json();
        }).then(function (data) {
            rows.innerText = `Rows: ${data.totalRows}`;
        }).catch(function (e) {
            throw e;
        });
    })();
</script>
</body>
</html>